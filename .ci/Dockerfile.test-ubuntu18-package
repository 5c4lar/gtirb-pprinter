FROM ubuntu:18.04 AS test-base

# Use bash for more convenient variable substitution syntax
SHELL ["/bin/bash", "-c"]

# dpkg-dev: for dpkg-scanpackages
# software-properties-common: for add-apt-repository
RUN apt-get -y update && apt-get -y install build-essential curl dpkg-dev software-properties-common \
    unzip

# for boost 1.67
RUN add-apt-repository ppa:mhier/libboost-latest

# setup gtirb package
COPY gtirb-ubuntu18-artifacts.zip gtirb-artifacts.zip
RUN unzip gtirb-artifacts.zip

# setup apt repository
COPY *.deb ./
RUN mkdir -p /gt/apt-repo
RUN cp *.deb /gt/apt-repo/
RUN cd /gt/apt-repo && dpkg-scanpackages . /dev/null > Packages
RUN echo $'\ndeb [trusted=yes] file:/gt/apt-repo ./\n' >> /etc/apt/sources.list


# Test libgtirb-pprinter dev by building a simple
# gtirb-pprinter-dependent program, then running it.
FROM test-base AS test-dev
RUN apt-get update && apt-get install -y --allow-unauthenticated libgtirb-pprinter-dev
WORKDIR /test/
COPY .ci/test-install.cpp test-install.cpp
RUN g++-7 test-install.cpp -std=c++17 -o test-install -lgtirb_pprinter -lstdc++fs
RUN ./test-install


# Test libgtirb-pprinter by copying the program built in the last stage and
# running it.
FROM test-base AS test-lib
RUN apt-get update && apt-get install -y --allow-unauthenticated libgtirb-pprinter
COPY --from=test-dev /test/test-install /test/test-install
WORKDIR /test/
RUN ./test-install


# Test gtirb-pprinter by running gtirb-pprinter and gtirb-layout on some example
# GTIRB
FROM test-base AS test-driver
COPY tests/two_modules.gtirb ./
RUN apt-get update && apt-get install -y --allow-unauthenticated gtirb-pprinter
RUN gtirb-pprinter two_modules.gtirb
RUN gtirb-layout two_modules.gtirb --out output


# Test libgtirb-pprinter-dbg by ensuring that the debug symbols are installed
# the correct location, and that the build-id section is set properly
FROM test-base AS test-libgtirb-pprinter-dbg
RUN apt-get update && apt-get install -y --allow-unauthenticated libgtirb-pprinter-dbg
RUN [ -f /usr/lib/debug/.build-id/$(readelf -n /usr/lib/libgtirb_pprinter.so | grep 'Build ID: ' | cut -d":" -f2 | sed -E 's/ ([a-f0-9]{2,})([a-f0-9]{30,})/\1\/\2/g').debug ]


# Test gtirb-pprinter-dbg by ensuring that the debug symbols are installed in
# the correct location, and that the build-id section is set properly
FROM test-base AS test-libgtirb-dbg
RUN apt-get update && apt-get install -y --allow-unauthenticated gtirb-pprinter-dbg
RUN [ -f /usr/lib/debug/.build-id/$(readelf -n /usr/bin/gtirb-pprinter | grep 'Build ID: ' | cut -d":" -f2 | sed -E 's/ ([a-f0-9]{2,})([a-f0-9]{30,})/\1\/\2/g').debug ]
